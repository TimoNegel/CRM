@page "/mitarbeiter/view/{Id:guid}"
@attribute [Authorize(Roles = "Admin")]


<MudText Typo="Typo.h4">Mitarbeiter Details</MudText>
<br />

<MudCard>
    <MudCardContent>
        <MudText><b>Vorname:</b> @mitarbeiter.Vorname</MudText>
        <MudText><b>Nachname:</b> @mitarbeiter.Nachname</MudText>
        <MudText><b>Team:</b> @mitarbeiter.Team.Name</MudText>
        <MudText><b>Rolle:</b> @rolle</MudText>
        <MudText><b>E-Mail:</b> @mitarbeiter.Email</MudText>
        <MudText><b>Telefonnummer:</b> @mitarbeiter.Telefonnummer</MudText>

        <MudText Typo="Typo.h5">Adresse</MudText>
        <MudText><b>Straße:</b> @mitarbeiter.Adresse.Strasse</MudText>
        <MudText><b>Hausnummer:</b> @mitarbeiter.Adresse.Hausnummer</MudText>
        <MudText><b>Ort:</b> @mitarbeiter.Adresse.Ort</MudText>
        <MudText><b>PLZ:</b> @mitarbeiter.Adresse.PLZ</MudText>
        <MudText><b>Land:</b> @mitarbeiter.Adresse.Land</MudText>
    </MudCardContent>

    <MudCardActions>
        <MudButton Color="Color.Primary" OnClick="() => NavigateToEditMitarbeiterPage()">Bearbeiten</MudButton>
        <MudButton Color="Color.Error" OnClick="() => DeleteMitarbeiter()">Löschen</MudButton>
    </MudCardActions>
</MudCard>

@code {
    [Parameter] public Guid Id { get; set; }
    private CrmUser mitarbeiter = new CrmUser { Adresse = new Adresse() };
    private string rolle = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        using var context = DbFactory.CreateDbContext();
        mitarbeiter = await context.Users.Include(m => m.Adresse).Include(m => m.Team).FirstOrDefaultAsync(m => m.IdGuid == Id) ?? new CrmUser();
        rolle = await GetMitarbeiterRole(mitarbeiter.Id);
    }

    private void NavigateToEditMitarbeiterPage()
    {
        Navigation.NavigateTo($"/mitarbeiter/edit/{Id}");
    }

    private async Task DeleteMitarbeiter()
    {
        using var context = DbFactory.CreateDbContext();
        var mitarbeiterToDelete = context.Users.FirstOrDefault(m => m.IdGuid == Id);
        if (mitarbeiterToDelete != null)
        {
            context.Users.Remove(mitarbeiterToDelete);
            await context.SaveChangesAsync();
            Navigation.NavigateTo("/mitarbeiter/view");
        }
    }

    private async Task<string> GetMitarbeiterRole(string id)
    {
        var user = await userManager.FindByIdAsync(id);
        if(user != null)
        {
            var currentRole = await userManager.GetRolesAsync(user);

            return currentRole[0];
        }
        return string.Empty;
    }
}
